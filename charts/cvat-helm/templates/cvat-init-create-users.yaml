{{ if .Values.superUser.create }}
apiVersion: batch/v1
kind: Job
metadata:
  name: cvat-init-create-users
  annotations:
    "helm.sh/hook": post-install,post-upgrade
    "helm.sh/hook-weight": "-5"
    "helm.sh/hook-delete-policy": hook-succeeded
spec:
  ttlSecondsAfterFinished: 10
  template:
    metadata:
      labels:
        app: cvat-init-create-users # has to match .spec.selector.matchLabels
    spec:
      restartPolicy: OnFailure
      containers:
      - name: cvat
        image: openvino/cvat_server
        env:
        - name: "CVAT_REDIS_HOST"
          value: 'cvat-redis'
        - name: CVAT_POSTGRES_HOST
          value: 'cvat-db'
        command: ["/bin/sh", "-c"]
        args:
            - |
              cat <<EOF | python manage.py shell
              from django.contrib.auth import get_user_model
              User = get_user_model()  # get the currently active user model,
              User.objects.filter(username='{{ .Values.superUser.username }}').exists() or \
                User.objects.create_superuser('{{ .Values.superUser.username }}', '{{ .Values.superUser.email }}', '{{ .Values.superUser.initialPassword }}')
              EOF
{{ end }}
